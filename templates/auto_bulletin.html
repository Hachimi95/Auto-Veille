{% extends 'base.html' %}
{% block title %}Auto Bulletin | Auto-Veille{% endblock %}
{% block content %}
<section class="container" style="max-width:800px; margin:0 auto; padding: 2rem; background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
  <h2 style="text-align:center; margin-bottom: 1.5rem; color: var(--primary-color);">Automatic Bulletin Extraction</h2>
  <form method="post" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
    <input type="text" name="url" placeholder="Bulletin URL (DGSSI or CERT-FR)" required style="padding: 0.8rem; border-radius: var(--radius); border: 1px solid #ddd;">
    <input type="text" name="bulletin_id" placeholder="Bulletin ID" required style="padding: 0.8rem; border-radius: var(--radius); border: 1px solid #ddd;">
    <button class="btn purple-btn" type="submit">Extract</button>
  </form>

  {% if extraction_error %}
    <div style="background: #e74c3c; padding: 12px 18px; border-radius: var(--radius); color: #fff; margin-bottom: 1.5rem; text-align: center;">
      {{ extraction_error }}
    </div>
  {% endif %}

  {% if extracted_data %}
    <form id="confirm-form" method="post" style="background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); padding: 24px 18px; margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem;">
      <input type="hidden" name="url" value="{{ request.form.url }}">
      <input type="hidden" name="bulletin_id" value="{{ request.form.bulletin_id }}">
      <input type="hidden" name="confirm" value="1">
      <label><b>Title:</b>
        <input type="text" name="titre" value="{{ extracted_data.titre or extracted_data.title }}" style="width:100%;padding:8px;margin-top:4px;">
      </label>
      <label><b>Date:</b>
        <input type="text" name="Date" value="{{ extracted_data.Date or extracted_data.date }}" style="width:100%;padding:8px;margin-top:4px;">
      </label>
      <label><b>Affected Products:</b>
        <textarea name="Produits affectés" style="width:100%;padding:8px;margin-top:4px;min-height:80px;">{{ extracted_data['Produits affectés']|join('\n') if extracted_data['Produits affectés'] else '' }}</textarea>
      </label>
      <label><b>CVEs:</b>
        <textarea name="CVEs ID" style="width:100%;padding:8px;margin-top:4px;min-height:80px;">{{ extracted_data['CVEs ID']|join('\n') if extracted_data['CVEs ID'] else '' }}</textarea>
      </label>
      <label><b>Score:</b>
        <input type="text" name="score" value="{{ extracted_data.score or '' }}" style="width:100%;padding:8px;margin-top:4px;">
      </label>
      <label><b>Delai:</b>
        <input type="text" name="Delai" value="{{ extracted_data.Delai or '' }}" style="width:100%;padding:8px;margin-top:4px;" placeholder="e.g., 30 Jr, 15 Jr, 5 Jr, 2 Jr">
      </label>
      <label><b>Risks:</b>
        <textarea name="risques" style="width:100%;padding:8px;margin-top:4px;min-height:80px;">{{ extracted_data.risques|join('\n') if extracted_data.risques else '' }}</textarea>
      </label>
      <label><b>Description:</b>
        <textarea name="Description" style="width:100%;padding:8px;margin-top:4px;min-height:80px;">{{ extracted_data.Description }}</textarea>
      </label>
      <label><b>Exploit:</b>
        <select name="Exploit" style="width:100%;padding:8px;margin-top:4px;">
          <option value="NON" {{ 'selected' if extracted_data.get('Exploit') == 'NON' else '' }}>NON</option>
          <option value="YES" {{ 'selected' if extracted_data.get('Exploit') == 'YES' else '' }}>YES</option>
        </select>
      </label>
      <label><b>Mitigations:</b>
  <textarea name="Mitigations" style="width:100%;padding:8px;margin-top:4px;min-height:120px;resize:vertical;">{{ extracted_data.Mitigations_display if extracted_data.Mitigations_display else '' }}</textarea>
      </label>
      <label><b>References:</b>
        <textarea name="Références" style="width:100%;padding:8px;margin-top:4px;min-height:80px;">{{ extracted_data['Références']|join('\n') if extracted_data['Références'] else '' }}</textarea>
      </label>
      <div style="display:flex;gap:18px;justify-content:center;margin-top:18px;">
        <button class="btn purple-btn" id="confirm-generate-btn" type="submit">Confirm & Generate</button>
      </div>
      <div id="loading-message" style="display:none;text-align:center;margin-top:12px;color:var(--accent);font-weight:600;">Processing...</div>
    </form>
  {% endif %}

  {% if generated_files %}
    <div style="text-align: center; margin-bottom: 1.5rem; display: flex; justify-content: center; gap: 32px;">
      <a href="?download={{ generated_files.pdf }}" title="Download PDF">
        <img src="/static/pdf.png" alt="Download PDF" style="width:54px;height:54px;object-fit:contain;filter:drop-shadow(0 2px 8px #764ba2cc);transition:transform 0.15s;cursor:pointer;" onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='none'">
      </a>
      <a href="?download={{ generated_files.word }}" title="Download Word">
        <img src="/static/doc.png" alt="Download Word" style="width:54px;height:54px;object-fit:contain;filter:drop-shadow(0 2px 8px #764ba2cc);transition:transform 0.15s;cursor:pointer;" onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='none'">
      </a>
    </div>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<style>
  .purple-btn {
    font-size: 1.05em;
    padding: 10px 28px;
    border-radius: 22px;
    background: #764ba2;
    color: #fff;
    font-weight: 700;
    border: none;
    box-shadow: 0 2px 8px rgba(94,93,240,0.08);
    transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
    cursor: pointer;
    letter-spacing: 0.5px;
    margin-top: 0.5em;
    min-width: 120px;
    min-height: 40px;
    display: inline-block;
  }
  .purple-btn:hover, .purple-btn:focus {
    background: #4e1c7e;
    box-shadow: 0 4px 16px rgba(94,93,240,0.16);
    transform: translateY(-2px) scale(1.03);
    color: #fff;
    outline: none;
  }
</style>
<script>
const confirmForm = document.getElementById('confirm-form');
if (confirmForm) {
  confirmForm.onsubmit = function() {
    document.getElementById('confirm-generate-btn').disabled = true;
    document.getElementById('loading-message').style.display = 'block';
  };
}
</script>
{% endblock %}